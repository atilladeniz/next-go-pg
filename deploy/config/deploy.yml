# Kamal 2.9 Deployment Configuration
# Docs: .docs/kamal-deploy.md
#
# Usage:
#   kamal setup -d staging     # First-time setup
#   kamal deploy -d staging    # Deploy to staging
#   kamal deploy -d production # Deploy to production

service: next-go-pg

# Docker Registry (GitHub Container Registry)
image: ghcr.io/<your-github-username>/next-go-pg

# Registry Login
registry:
  server: ghcr.io
  username:
    - KAMAL_REGISTRY_USERNAME
  password:
    - KAMAL_REGISTRY_PASSWORD

# Builder Configuration
builder:
  arch: amd64
  context: ..
  dockerfile: deploy/Dockerfile
  args:
    COMMIT_SHA: <%= `git rev-parse HEAD`.strip %>

# SSH Configuration
ssh:
  user: root
  keys_only: true
  # keys: ["~/.ssh/id_ed25519"]

# Healthcheck - kamal-proxy checks this endpoint
proxy:
  ssl: true
  host: app.example.com
  healthcheck:
    interval: 3
    path: /health
    timeout: 3

# Environment Variables (non-secret)
env:
  clear:
    RAILS_ENV: production
    GO_ENV: production
  secret:
    - DATABASE_URL
    - BETTER_AUTH_SECRET
    - NEXT_PUBLIC_APP_URL
    - NEXT_PUBLIC_API_URL

# Logging
logging:
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"

# Accessories (Database, Logging, etc.)
# For production DB: Use managed DB (Hetzner, DO, AWS RDS)
accessories:
  # Loki - Log Aggregation (self-hosted)
  loki:
    image: grafana/loki:2.9.0
    roles:
      - web
    port: 3100
    files:
      - deploy/loki/loki-config.prod.yml:/etc/loki/local-config.yaml
    directories:
      - loki_data:/loki
    cmd: -config.file=/etc/loki/local-config.yaml
    options:
      user: "0"
      restart: unless-stopped
      memory: 512m
      cpus: 1

  # Grafana - Log Visualization
  grafana:
    image: grafana/grafana:10.2.0
    roles:
      - web
    port: 3001:3000
    env:
      clear:
        GF_SECURITY_ADMIN_USER: admin
        GF_USERS_ALLOW_SIGN_UP: "false"
        GF_AUTH_ANONYMOUS_ENABLED: "false"
        GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH: /etc/grafana/provisioning/dashboards/next-go-pg.json
        GF_LOG_MODE: console
        GF_LOG_LEVEL: warn
      secret:
        - GF_SECURITY_ADMIN_PASSWORD
    files:
      - deploy/grafana/provisioning/datasources/datasources.prod.yml:/etc/grafana/provisioning/datasources/datasources.yml
      - deploy/grafana/provisioning/dashboards/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml
      - deploy/grafana/provisioning/dashboards/next-go-pg.json:/etc/grafana/provisioning/dashboards/next-go-pg.json
    directories:
      - grafana_data:/var/lib/grafana
    options:
      restart: unless-stopped
      memory: 256m
      cpus: 0.5

# Optional: Uncomment to let Kamal manage PostgreSQL
# For production: Use managed DB (Hetzner, DO, AWS RDS)
#
#   db:
#     image: postgres:16-alpine
#     host: db.example.com
#     port: 5432
#     env:
#       secret:
#         - POSTGRES_PASSWORD
#     directories:
#       - data:/var/lib/postgresql/data
#     options:
#       restart: unless-stopped

# Boot Configuration
boot:
  limit: 3  # Deploy to 3 servers at a time (rolling deploy)
  wait: 5   # Wait 5 seconds between batches

# Retain old containers for rollback
retain_containers: 5
